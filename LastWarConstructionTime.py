import streamlit as st
from datetime import datetime, timedelta
import re

# ----------------------
# ìœ í‹¸ í•¨ìˆ˜
# ----------------------
def to_million(m_value: float) -> str:
    if float(m_value).is_integer():
        return f"{int(m_value)}M"
    return f"{m_value:.1f}M"

def add_space(text: str) -> str:
    return re.sub(r"([ê°€-í£A-Za-z]+)(\d+)", r"\1 \2", text)

# ----------------------
# í˜ì´ì§€ ì„¤ì •
# ----------------------
st.set_page_config(
    page_title="Last War ê±´ì„¤ ì‹œê°„ ê³„ì‚°ê¸°",
    page_icon="lastwarg.png",
    layout="centered"
)

st.image("lastwarg.png", width=72)
st.markdown("## Last War ê±´ì„¤ ì‹œê°„ ê³„ì‚°ê¸°")
st.caption("ê±´ë¬¼ ì—…ê·¸ë ˆì´ë“œ ì‹œ ì˜ˆìƒ ì™„ë£Œ ì‹œê°„ê³¼ í•„ìš” ìì›ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.divider()

# ----------------------
# ë°ì´í„° (Lv.10 â†’ 30 ì „ë¶€)
# ----------------------
HQ_DATA = {
    "10 â†’ 11": {"time": (0, 7, 4, 0),  "res": (1.9, 1.9, 0.6),  "req": ("ê³¼í•™ì„¼í„°10", "ë² ë¦¬ì–´10")},
    "11 â†’ 12": {"time": (0, 9, 6, 0),  "res": (3.2, 3.2, 1.0),  "req": ("ê³¼í•™ì„¼í„°11", "ë³‘ì˜11")},
    "12 â†’ 13": {"time": (0,12, 5, 0), "res": (3.5, 3.5, 1.1),  "req": ("ê³¼í•™ì„¼í„°12", "íƒ±í¬ì„¼í„°12")},
    "13 â†’ 14": {"time": (0,16, 2, 0), "res": (4.9, 4.9, 1.6),  "req": ("ê³¼í•™ì„¼í„°13", "ì—°ë³‘ì¥13")},
    "14 â†’ 15": {"time": (0,22, 7, 0), "res": (6.8, 6.8, 2.2),  "req": ("ê³¼í•™ì„¼í„°14", "ë² ë¦¬ì–´14")},
    "15 â†’ 16": {"time": (1, 7,48, 0), "res": (12, 12, 3.9),   "req": ("ê³¼í•™ì„¼í„°15", "ì—°ë§¹ì„¼í„°15")},
    "16 â†’ 17": {"time": (1,19,12, 0), "res": (16, 16, 5.1),   "req": ("ê³¼í•™ì„¼í„°16", "íƒ±í¬ì„¼í„°16")},
    "17 â†’ 18": {"time": (2,14,24, 0), "res": (28, 28, 8.9),   "req": ("ê³¼í•™ì„¼í„°17", "ë³‘ì›17")},
    "18 â†’ 19": {"time": (3,14,24, 0), "res": (33, 33, 11),    "req": ("ê³¼í•™ì„¼í„°18", "ë² ë¦¬ì–´18")},
    "19 â†’ 20": {"time": (5, 2,24, 0), "res": (60, 60, 19),    "req": ("ê³¼í•™ì„¼í„°19", "ë³‘ì˜19")},
    "20 â†’ 21": {"time": (6,14,24, 0), "res": (84, 84, 27),    "req": ("ê³¼í•™ì„¼í„°20", "íƒ±í¬ì„¼í„°20")},
    "21 â†’ 22": {"time": (8,14,24, 0), "res": (110,110,35),    "req": ("ê³¼í•™ì„¼í„°21", "ì—°ë³‘ì¥21")},
    "22 â†’ 23": {"time": (11, 2,24,0), "res": (140,140,44),    "req": ("ê³¼í•™ì„¼í„°22", "ë² ë¦¬ì–´22")},
    "23 â†’ 24": {"time": (15,14,24,0), "res": (170,170,54),    "req": ("ê³¼í•™ì„¼í„°23", "ì—°ë§¹ì„¼í„°23")},
    "24 â†’ 25": {"time": (21,21,36,0), "res": (290,290,93),    "req": ("ê³¼í•™ì„¼í„°24", "íƒ±í¬ì„¼í„°24")},
    "25 â†’ 26": {"time": (30,14,24,0), "res": (400,400,130),   "req": ("ê³¼í•™ì„¼í„°25", "ë³‘ì›25")},
    "26 â†’ 27": {"time": (42,21,36,0), "res": (530,530,170),   "req": ("ê³¼í•™ì„¼í„°26", "ë² ë¦¬ì–´26")},
    "27 â†’ 28": {"time": (60, 2,24,0), "res": (740,740,240),   "req": ("ê³¼í•™ì„¼í„°27", "ë³‘ì˜27")},
    "28 â†’ 29": {"time": (78, 2,24,0), "res": (1000,1000,330), "req": ("ê³¼í•™ì„¼í„°28", "íƒ±í¬ì„¼í„°28")},
    "29 â†’ 30": {"time": (101,14,24,0),"res": (1400,1400,460), "req": ("ê³¼í•™ì„¼í„°29", "ì—°ë³‘ì¥29")},
}

# ----------------------
# ì„ íƒ
# ----------------------
st.subheader("ğŸ› ï¸ ë³¸ë¶€ ì—…ê·¸ë ˆì´ë“œ ì„ íƒ")
level = st.selectbox("ë ˆë²¨ êµ¬ê°„", list(HQ_DATA.keys())[::-1])
data = HQ_DATA[level]

d, h, m, s = data["time"]
iron, food, gold = data["res"]
req1, req2 = map(add_space, data["req"])

# ----------------------
# ê¸°ë³¸ ì‹œê°„ (í¬ê²Œ)
# ----------------------
st.markdown(
    f"""
    <div style="font-size:26px;font-weight:700;">
        â±ï¸ ê¸°ë³¸ ê±´ì„¤ ì‹œê°„<br>
        <span style="font-size:32px;">
        {d}D {h:02}:{m:02}:{s:02}
        </span>
    </div>
    """,
    unsafe_allow_html=True
)

st.divider()

# ----------------------
# ìì›
# ----------------------
st.subheader("ğŸ“¦ í•„ìš” ìì›")

c1, c2, c3 = st.columns(3)
with c1:
    st.image("iron.png", width=48)
    st.markdown(f"**ì² **  \n{to_million(iron)}")

with c2:
    st.image("food.png", width=48)
    st.markdown(f"**ì‹ëŸ‰**  \n{to_million(food)}")

with c3:
    st.image("gold.png", width=48)
    st.markdown(f"**ê³¨ë“œ**  \n{to_million(gold)}")

# ----------------------
# ìš”êµ¬ì¡°ê±´
# ----------------------
st.subheader("ğŸ“Œ ìš”êµ¬ ì¡°ê±´")
st.markdown(f"- {req1}\n- {req2}")

st.divider()

# ----------------------
# ê°€ì† ê³„ì‚°
# ----------------------
st.subheader("âš¡ ê±´ì„¤ ê°€ì†")

my_speed = st.number_input("ë‚˜ì˜ ê±´ì„¤ ì†ë„ (%)", 0.0, 500.0, 0.0, 0.1)
mayor = st.selectbox("ê±´ì„¤ ì¥ê´€ ê°€ì† (%)", [0.0, 25.0, 50.0], index=2)

if st.button("ğŸš€ ê³„ì‚°í•˜ê¸°", use_container_width=True):
    base_sec = d*86400 + h*3600 + m*60 + s
    total_speed = (my_speed + mayor) / 100
    final_sec = base_sec / (1 + total_speed)

    dur = timedelta(seconds=int(final_sec))
    end_time = datetime.now() + dur

    st.success("ê³„ì‚° ì™„ë£Œ")
    st.metric("â±ï¸ ìµœì¢… ê±´ì„¤ ì‹œê°„", f"{dur.days}D {dur.seconds//3600:02}:{(dur.seconds%3600)//60:02}")
    st.metric("ğŸ“… ì™„ë£Œ ì˜ˆì • ì‹œê°", end_time.strftime("%Y-%m-%d %H:%M:%S"))

# ----------------------
# ê³µì‹
# ----------------------
st.divider()
st.subheader("ğŸ“˜ ê³„ì‚° ê³µì‹")
st.markdown(
    "- **ìµœì¢… ê±´ì„¤ ì‹œê°„ = ê¸°ë³¸ ê±´ì„¤ ì‹œê°„ Ã· (1 + ì´ ê±´ì„¤ ê°€ì† %)**\n"
    "- ì´ ê°€ì† = ë‚˜ì˜ ê±´ì„¤ ì†ë„ + ê±´ì„¤ ì¥ê´€ ê°€ì†\n"
    "- ìì›ì€ M ë‹¨ìœ„ ê¸°ì¤€"
)
